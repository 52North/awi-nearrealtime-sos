<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN" "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping schema="public" package="org.n52.sensorweb.awi.data.entities">

    <class name="Platform" mutable="false" table="platform" where="code is not null and type is not null and public = 't'">
        <id name="id" type="int" column="platform_id" />
        <property name="name" type="string" column="platform" />
        <property name="code" type="string">
            <formula>(type || ':' || code)</formula>
        </property>
        <property name="geometry" type="org.hibernate.spatial.GeometryType">
            <formula>ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)</formula>
        </property>
        <property name="published" type="boolean" column="public" />
        <set name="devices" table="device" where="code is not null" fetch="join" lazy="false">
            <key column="platform_id" />
            <one-to-many class="Device" />
        </set>
        <set name="expeditions" table="v_expedition" where="begin_date &lt;= end_date" fetch="select" lazy="true">
            <key column="platform_id" />
            <one-to-many class="Expedition" />
        </set>
    </class>

    <class name="Device" mutable="false" table="device"  where="code is not null">
        <id name="id" type="int" column="device_id" />
        <many-to-one name="platform" class="Platform" fetch="join" lazy="false" >
            <column name="platform_id" />
        </many-to-one>
        <property name="name" type="string" column="device" />
        <property name="code" type="string" column="code" />
        <set name="sensors" table="sensor" where="code is not null" fetch="join" lazy="false">
            <key column="device_id" />
            <one-to-many class="Sensor" />
        </set>
    </class>

    <class name="Sensor" mutable="false" table="sensor" where="code is not null">
        <id name="id" type="int" column="sensor_id" />
        <many-to-one name="device" class="Device" column="device_id" fetch="join" lazy="false" />
        <property name="name" type="string" column="sensor" />
        <property name="unit" type="string" column="unit" />
        <property name="code" type="string" column="code" />
    </class>

    <class name="Data" mutable="false" table="dataview">
        <id name="id" type="int" column="data_id" />
        <property name="time" type="timestamp" column="date" />
        <property name="value" type="double" column="mean" />
        <property name="geometry" type="org.hibernate.spatial.GeometryType">
            <formula>ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)</formula>
        </property>
        <property name="code" type="string" column="code" />
        <many-to-one name="sensor" class="Sensor" column="sensor_id" fetch="join" lazy="false" />
    </class>

    <class name="Expedition" mutable="false" table="v_expedition" where="begin_date &lt;= end_date">
        <id name="name" type="string" column="expedition" />
        <property name="platform" type="string">
            <formula>(select p.type || ':' || p.code from platform as p where p.platform_id = platform_id)</formula>
        </property>
        <property name="begin" type="date" column="begin_date" />
        <property name="end" type="date" column="end_date" />
    </class>

    <class name="ExpeditionGeometry" mutable="false" table="v_expedition" where="begin_date &lt;= end_date" >
        <id name="name" type="string" column="expedition" />
        <property name="platform" type="string">
            <formula>(select p.type || ':' || p.code from platform as p where p.platform_id = platform_id)</formula>
        </property>
        <property name="begin" type="date" column="begin_date" />
        <property name="end" type="date" column="end_date" />
        <property name="geometry" type="org.hibernate.spatial.GeometryType" column="geom" />
    </class>

</hibernate-mapping>



